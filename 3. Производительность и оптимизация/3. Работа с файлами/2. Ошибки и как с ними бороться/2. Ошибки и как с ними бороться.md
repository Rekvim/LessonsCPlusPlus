## Ошибки и как с ними бороться
Потоки существуют в C++ с самого момента создания языка и поэтому имеют свою специфику. В этом уроке разберём, как различать ошибки потока и как работать с потоком после ошибки.

Поток `istream` будет конвертироваться в `true`, только если последняя операция чтения прошла успешно. Перечислим причины, по которым чтение могло не получиться.
1. Неудача при открытии файла или другая ошибка, произошедшая до чтения. Например, файла нет или недостаточно прав.
2. Ошибка ввода-вывода. Например, на файл пришёлся битый сектор диска, либо пользователь вынул флешку с файлом во время чтения.
3. В потоке находится не число.
4. Достигнут конец файла. Поскольку в примере это первое чтение, значит, файл пуст или состоял из пробелов.

Первая и вторая ситуации — критические. Скорее всего, с потоком уже ничего не получится сделать.

Третья ситуация позволяет выполнять другое чтение. Последняя ситуация — штатная.

Чтобы различить причины неудавшегося чтения в потоке, предусмотрены три флага:
- `badbit` — обозначает критическую ошибку;
- `failbit` — обозначает некритическую ошибку;
  
- `eofbit` — обозначает конец файла. При этом достижение конца файла не означает, что последняя операция была неуспешной. Но он означает, что следующая операция чтения точно будет неуспешной.

Читать и задавать флаги можно сеттером `clear` и геттерами. Почитайте о них в документации по базовому классу для потоков ввода и вывода `std::basic_ios`.

Рассмотрим такую программу:
```cpp
int main(int argc, const char** argv) {
    // открываем файл, указанный в первом аргументе командной строки
    ifstream input(argv[1]);

    while (input) {
        int times;
        string action;

        if (input >> times >> action) {
            for (int i = 0; i < times; ++i) {
                cout << action << "! "s;
            }
            cout << endl;
        } else {
            string action2;
            if (input >> action2) {
                cout << action2 << "!"s << endl;
            }
        }
    }
} 
```
По задумке такая программа должна поддерживать команды двух видов:
1. Число, действие.
   
2. Действие.
   
Подадим на вход следующий файл:
```
3 clap
3 jump
turn
3 stomp 
```
Всё просто: трижды хлопнуть, трижды подпрыгнуть, повернуться и три раза топнуть. Запустим программу и увидим такой результат:
```
clap! clap! clap!
jump! jump! jump! 
```
На прыжках всё закончилось. Дело в том, что после первой ошибки чтение останавливается. Сколько бы вы ни пытались читать из потока, операции ввода-вывода не будут выполняться, если поток имеет установленный флаг `failbit` или `badbit`.

Если бы чтения продолжались после ошибки, условие оператора `if (input >> times >> action)` было бы истинным, поскольку выполнилось бы второе чтение. Значение переменной `times` оказалось бы незаданным, что должно было привести к неопределённому поведению.

Если ошибка не фатальная, поток может ещё пригодиться. Чтобы продолжить попытки чтения и заставить операцию `>>` снова работать, нужно сбросить флаги вручную методом `clear`.

Можно исправить программу, добавив сброс флагов перед попыткой чтения второй команды:
```cpp
int main(int argc, const char** argv) {
    // открываем файл, указанный в первом аргументе командной строки
    ifstream input(argv[1]);

    while (input) {
        int times;
        string action;

        if (input >> times >> action) {
            for (int i = 0; i < times; ++i) {
                cout << action << "! "s;
            }
            cout << endl;
        } else {
            string action2;

            // сбрасываем флаги ошибок перед новым чтением:
            input.clear();
            if (input >> action2) {
                cout << action2 << "!"s << endl;
            }
        }
    }
} 
```
Работа программы исправилась, вывод корректный:
```
clap! clap! clap!
jump! jump! jump!
turn!
stomp! stomp! stomp! 
```
По умолчанию потоки не кидают исключений. Однако можно попросить поток делать это при ошибке во время установки флага `failbit` или `badbit`. Переключить поток в режим выбрасывания исключений при ошибке ввода-вывода позволит метод exceptions. В этом курсе исключения потоков не понадобятся. Узнать больше о методе exception вы можете из документации.

Поток из условия цикла конвертируется к `bool`. При этом значение `false` будет получаться, если у потока установлен флаг ошибки: `failbit` или `badbit`.

Одной лишней итерации можно избежать, если заменить условие на `input.good()`. Метод `good` потока будет возвращать `false` также при наличии флага `eofbit`, а значит, позволит не гонять цикл, когда все операции чтения точно будут неуспешны.
На самом деле, даже использование `good` не даст гарантии корректных чтений. В потоке может остаться пробел или перевод строки, и, с точки зрения потока, это ещё не конец. Однако `good` лучше подходит по семантике в данном случае:
- конвертацию к `bool` уместно применять после чтения, чтобы проверить, прошло ли оно успешно;
- метод `good` уместно применять перед чтением, чтобы проверить, есть ли у последующего чтения шансы.

Мы выяснили, что ошибка — это ещё не конец для потока, однако перед следующей операцией нужно очистить флаги. В следующем уроке разберём, с какими сложностями можно столкнуться при открытии файла, как прыгать по файлам и ориентироваться в них.