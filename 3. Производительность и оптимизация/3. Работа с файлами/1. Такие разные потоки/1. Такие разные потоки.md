## Такие разные потоки

Компьютеры, смартфоны и многие другие устройства, способные исполнять программы, трудно представить без важного элемента — энергонезависимого носителя, такого как жёсткий или твердотельный диск. У постоянной памяти, размещаемой на этом носителе, есть свои особенности. Главная из них — необходимость в файловой системе, которая структурирует данные на диске. В этой теме рассмотрим работу с потоками. Начнём с чтения и записи файлов. Но прежде вспомним, как устроены потоки ввода-вывода, через которые осуществляются основные операции с файлами.

У потока две стороны: одна посылает данные, другая получает. Одна из этих сторон — активная, это функция или метод вашей программы. Задача другой — выдать или принять данные по запросу. Потоки ввода-вывода — замечательный пример разделения ответственности. Эти стороны могут не знать друг о друге ничего: одна посылает данные в поток, не представляя, куда они попадут, другая — обрабатывает данные, не имея понятия о том, откуда они пришли.

Давайте проверим, что вы уже знаете о потоках.

Помимо потоков стандартного ввода и вывода есть строковые потоки, которые работают с памятью: `istringstream` и `ostringstream`. Потоки `cin` и `cout` существуют в одном экземпляре. А строковых потоков можно создать несколько при необходимости.

Поток ввода можно представить ссылкой на `istream&`. Активная сторона читает данные из него. К потокам ввода относятся cin и istringstream из библиотеки `<sstream>`.

Поток вывода представляется ссылкой на `ostream&`. Активная сторона может записывать данные в него. Этот поток содержит кэширование, ускоряющее его работу. К потокам вывода относятся `ostringstream` из библиотеки `<sstream>` и знакомый вам cout из `<iostream>`.

Помимо этих двух потоков существует также тип iostream. Ссылкой этого типа можно представить поток, допускающий как чтение, так и запись. Примером служит `stringstream`.

Для работы с файлами в стандартной библиотеке есть специальные потоки, которые станут доступны при подключении файла `<fstream>`:
- поток ввода `ifstream` для чтения из файла,
- поток вывода `ofstream` для записи в файл,
- поток `fstream` для выполнения сразу обеих операций.
  
При создании потока в конструктор нужно передать имя файла:
```cpp
#include <fstream>
#include <iostream>
#include <string>

using namespace std;

int main() {
    {
        ifstream in_file("test.txt"s);
        int x; 
        if (in_file >> x) {
            cout << "Из файла прочитано число "s << x << endl;
        }
    }

    {
        ofstream out_file("test.txt"s);
        out_file << 100 << 500 << endl;
    }
} 
```
При первом запуске этой программы в консоль не будет выведено ничего — файла с именем test.txt нет и прочитать из него не получится. Вторая половина программы автоматически создаст этот файл и запишет в него два числа — ofstream автоматически создаёт файл, если его нет. Имейте в виду, что ofstream не создаёт папки — открытие будет успешным только в том случае, если директория файла уже существует, и на создание файла в ней у программы есть права.

Если всё прошло успешно, после второго запуска появится текст:
```
Из файла прочитано число 100500 
```
Два записанных числа склеились в одно, поскольку мы не вывели между ними никакого разделителя — пробела или перевода строки. Так произошло бы и при выводе в `cout`.

После третьего запуска результат не изменится — `ofstream` очищает файл, если он существует, и начинает с чистого листа. Следует быть осторожными и не открывать через `ofstream` файл, содержащий нужные данные.

Поскольку указано только имя файла без указания пути, файл будет создан в текущей директории — папке, задаваемой окружением операционной системы. Текущая директория зависит от того, как пользователь запустил программу. Если она вызвана из проводника, текущая директория будет папкой программы. Если из консоли, то активной директорией в консоли. В C++ есть функции для изменения и получения текущей директории. Об этом — в конце темы.

Директория используется для интерпретации относительных путей. Например, если программа обращается к файлу “dir/a.txt” без указания полного пути до него, будет подразумеваться, что этот файл находится в поддиректории dir текущей директории. При запуске из IDE текущая директория задаётся в настройках проекта. Часто текущая папка совпадает с папкой исполняемого файла вашей программы, но так происходит не всегда.

Объекты классов `fstream`, `ifstream`, `ofstream` можно создавать и с пустым конструктором. В этом случае для открытия файла примените метод `open`, который принимает такие же параметры, как и конструктор. Более того, можно открыть другой файл тем же потоком, вызвав `open` повторно. Перед этим нужно закрыть файл методом `close`, который не принимает параметров. Пока файл открыт каким-либо потоком, он зарезервирован за вашей программой. Операционная система может препятствовать другим программам совершать действия с этим файлом, например удалять его. Но это не значит, что нужно вызывать `close` каждый раз после открытия файла, чтобы снять резерв. В C++ это происходит в деструкторе потока автоматически. Поэтому можно не бояться, что забудете закрыть файл и допустите утечку ресурсов.

Подведём итог этого урока таблицей, содержащей все известные на данный момент потоки:

||Стандартный ввод-вывод|Строковый поток|Файловый поток|
|:-:|:-:|:-:|:-:|
Заголовочный файл|`<iostream>`|`<sstream>`|`<fstream>`
Поток ввода|`cin`|`istringstream`|`ifstream`|
Поток вывода	|`cout`, `cerr`|	`ostringstream`|	`ofstream`
Двунаправленный поток	|—	|`stringstream`	|`fstream`